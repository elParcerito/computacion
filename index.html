<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestión Sala de Computación</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4;}
header { background:#2c3e50; color:white; padding:1em; text-align:center;}
main { padding:20px; }
.hide { display:none; }
button { cursor:pointer; padding:5px 10px; margin:5px; }
input, select, textarea { margin:5px 0; padding:5px; width:100%; }
table { width:100%; border-collapse: collapse; margin-top:10px; }
th, td { border:1px solid #ccc; padding:5px; text-align:left; }
th { background:#ecf0f1; }
nav button { margin-right:10px; }
.form-section { background:white; padding:15px; margin-bottom:20px; border-radius:5px; box-shadow:0 0 5px rgba(0,0,0,0.1); }
#errorMsg { color:red; margin-top:10px; }
</style>
</head>
<body>
<header>
<h1>Gestión Sala de Computación</h1>
</header>
<main>
  <!-- Login -->
  <div id="loginDiv">
    <h2>Iniciar sesión</h2>
    <input type="email" id="email" placeholder="Correo">
    <input type="password" id="password" placeholder="Contraseña">
    <button onclick="login()">Entrar</button>
    <div id="errorMsg"></div>
  </div>

  <!-- Panel principal -->
  <div id="panelDiv" class="hide">
    <nav>
      <button onclick="showSection('prestamos')">Préstamos</button>
      <button onclick="showSection('reservas')">Reservas</button>
      <button onclick="showSection('reportes')">Problemas Técnicos</button>
      <button id="btnInventario" onclick="showSection('inventario')">Inventario</button>
      <button onclick="logout()">Cerrar sesión</button>
    </nav>

    <!-- Préstamos -->
    <div id="prestamos" class="form-section">
      <h3>Registrar préstamo de equipo</h3>
      <input type="text" id="prestaNombre" placeholder="Nombre de quien recibe">
      <input type="text" id="prestaEquipo" placeholder="Equipo (notebook, parlante...)">
      <input type="date" id="prestaFecha">
      <input type="date" id="devolFecha">
      <textarea id="prestaObs" placeholder="Observaciones"></textarea>
      <button onclick="agregarPrestamo()">Agregar préstamo</button>
      <table id="tablaPrestamos">
        <thead><tr><th>Nombre</th><th>Equipo</th><th>Préstamo</th><th>Devolución</th><th>Obs</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Reservas -->
    <div id="reservas" class="form-section hide">
      <h3>Reservar Sala de Computación</h3>
      <input type="text" id="reservaNombre" placeholder="Nombre del docente">
      <input type="datetime-local" placeholder="Fecha de inicio"id="reservaInicio">
      <input type="datetime-local" placeholder="Fecha final"id="reservaFin">
      <textarea id="reservaObs" placeholder="Observaciones"></textarea>
      <button onclick="agregarReserva()">Agregar reserva</button>
      <table id="tablaReservas">
        <thead><tr><th>Docente</th><th>Inicio</th><th>Fin</th><th>Obs</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Reportes -->
    <div id="reportes" class="form-section hide">
      <h3>Reportar Problema Técnico</h3>
      <input type="text" id="repEquipo" placeholder="Equipo afectado">
      <textarea id="repDesc" placeholder="Descripción del problema"></textarea>
      <button onclick="agregarReporte()">Agregar reporte</button>
      <table id="tablaReportes">
        <thead><tr><th>Equipo</th><th>Descripción</th><th>Fecha</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Inventario -->
    <div id="inventario" class="form-section hide">
      <h3>Inventario de Equipos</h3>
      <input type="text" id="invEquipo" placeholder="Nombre del equipo">
      <select id="invEstado">
        <option value="Disponible">Disponible</option>
        <option value="Prestado">Prestado</option>
        <option value="En reparación">En reparación</option>
      </select>
      <button onclick="agregarInventario()">Agregar/Actualizar</button>
      <table id="tablaInventario">
        <thead><tr><th>Equipo</th><th>Estado</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

<script>
  // Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAPHhy2F-SnYjpK6mUJdFtpsTY5g4Nzb-E",
    authDomain: "computacion-4cee0.firebaseapp.com",
    projectId: "computacion-4cee0",
    storageBucket: "computacion-4cee0.firebasestorage.app",
    messagingSenderId: "449754684793",
    appId: "1:449754684793:web:8608ce291f51ee543da3a8"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const errorMsg = document.getElementById('errorMsg');

  // Login
  function login() {
    errorMsg.textContent = '';
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    auth.signInWithEmailAndPassword(email,password)
      .then(()=>{})
      .catch(e=>errorMsg.textContent = e.message);
  }

  function logout(){
    auth.signOut();
  }

  function showSection(id){
    ['prestamos','reservas','reportes','inventario'].forEach(s => document.getElementById(s).classList.add('hide'));
    document.getElementById(id).classList.remove('hide');
  }

  // Control de roles y carga de panel
  auth.onAuthStateChanged(user=>{
    if(user){
      db.collection('usuarios').doc(user.uid).get().then(doc=>{
        if(doc.exists){
          const rol = doc.data().rol;
          if(rol==='profesor'){
            document.getElementById('btnInventario').style.display='none'; // Oculta inventario
          } else if(rol==='encargado'){
            document.getElementById('btnInventario').style.display='inline-block';
          }
          document.getElementById('panelDiv').classList.remove('hide');
          document.getElementById('loginDiv').classList.add('hide');
          cargarDatos();
        } else {
          errorMsg.textContent = "Usuario no registrado en la base de datos (Firestore). Contacta al administrador.";
          auth.signOut();
        }
      }).catch(err=>{
        errorMsg.textContent = "Error al leer Firestore: " + err.message;
        auth.signOut();
      });
    } else {
      document.getElementById('panelDiv').classList.add('hide');
      document.getElementById('loginDiv').classList.remove('hide');
    }
  });

  // Funciones Firestore
  function agregarPrestamo(){
    const nombre=document.getElementById('prestaNombre').value;
    const equipo=document.getElementById('prestaEquipo').value;
    const fecha=document.getElementById('prestaFecha').value;
    const devol=document.getElementById('devolFecha').value;
    const obs=document.getElementById('prestaObs').value;
    db.collection('prestamos').add({nombre,equipo,fecha,devol,obs}).then(()=>cargarPrestamos());
  }

  function agregarReserva(){
    const nombre=document.getElementById('reservaNombre').value;
    const inicio=document.getElementById('reservaInicio').value;
    const fin=document.getElementById('reservaFin').value;
    const obs=document.getElementById('reservaObs').value;
    db.collection('reservas').add({nombre,inicio,fin,obs}).then(()=>cargarReservas());
  }

  function agregarReporte(){
    const equipo=document.getElementById('repEquipo').value;
    const desc=document.getElementById('repDesc').value;
    const fecha=new Date().toLocaleString();
    db.collection('reportes').add({equipo,desc,fecha}).then(()=>cargarReportes());
  }

  function agregarInventario(){
    const equipo=document.getElementById('invEquipo').value;
    const estado=document.getElementById('invEstado').value;
    db.collection('inventario').doc(equipo).set({estado}).then(()=>cargarInventario());
  }

  // Cargar datos
  function cargarDatos(){
    cargarPrestamos();
    cargarReservas();
    cargarReportes();
    cargarInventario();
  }

  function cargarPrestamos(){
    const tbody=document.querySelector('#tablaPrestamos tbody');
    tbody.innerHTML='';
    db.collection('prestamos').get().then(snapshot=>{
      snapshot.forEach(doc=>{
        const d=doc.data();
        tbody.innerHTML+=`<tr><td>${d.nombre}</td><td>${d.equipo}</td><td>${d.fecha}</td><td>${d.devol}</td><td>${d.obs}</td></tr>`;
      });
    });
  }

  function cargarReservas(){
    const tbody=document.querySelector('#tablaReservas tbody');
    tbody.innerHTML='';
    db.collection('reservas').get().then(snapshot=>{
      snapshot.forEach(doc=>{
        const d=doc.data();
        tbody.innerHTML+=`<tr><td>${d.nombre}</td><td>${d.inicio}</td><td>${d.fin}</td><td>${d.obs}</td></tr>`;
      });
    });
  }

  function cargarReportes(){
    const tbody=document.querySelector('#tablaReportes tbody');
    tbody.innerHTML='';
    db.collection('reportes').get().then(snapshot=>{
      snapshot.forEach(doc=>{
        const d=doc.data();
        tbody.innerHTML+=`<tr><td>${d.equipo}</td><td>${d.desc}</td><td>${d.fecha}</td></tr>`;
      });
    });
  }

  function cargarInventario(){
    const tbody=document.querySelector('#tablaInventario tbody');
    tbody.innerHTML='';
    db.collection('inventario').get().then(snapshot=>{
      snapshot.forEach(doc=>{
        const d=doc.data();
        tbody.innerHTML+=`<tr><td>${doc.id}</td><td>${d.estado}</td></tr>`;
      });
    });
  }

</script>
</body>
</html>